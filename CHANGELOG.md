# Changelog

## [Unreleased]

### 2025-12-09
- Style article links with blue color and underline on hover only
- Address PR review feedback for layout improvements
  - Extract `extractDocPath()` helper function in router.ts to deduplicate path extraction logic
  - Add comment explaining magic number in NavItem spacer width calculation
  - Fix ToC filter to explicitly exclude H1 headings (`entry.level >= 2 && entry.level <= 3`)
  - Add early return optimization to `expandOnlyTo()` to avoid unnecessary re-renders
- Improve navigation sidebar styling
  - Use consistent text size (text-sm) for all navigation items regardless of depth
  - Reduce vertical padding from py-1.5 to py-1
  - Reduce horizontal padding from px-2 to px-1.5
  - Reduce indentation for nested items from ml-4 to ml-3
  - Reduce arrow button size and spacing (w-5 to w-4, mr-1 to mr-0.5)
  - Remove background highlight from active navigation item
  - Stylize logo: uppercase with "STAGE" in lighter gray
  - Fix code block readability by adding explicit dark text color
  - Limit table of contents to two levels deep (h2 and h3 only)
- Auto-collapse navigation items except the path to current page
  - All navigation items with children are collapsed by default
  - Only the path to the currently viewed page is expanded
  - Navigation auto-expands when navigating to a new page
  - Collapsed state is no longer persisted to localStorage
- Add bottom padding to main content container for consistent spacing

### 2025-12-08
- Address PR review feedback for live reload
  - Fix `onReload` callback capturing stale path by reading current path from store
  - Fix potential memory leak by returning unsubscribe function from `onReload`
  - Rename `format` variable to `fmt` to avoid shadowing builtin in diagrams module
  - Replace broad `Exception` catch with specific network exceptions
  - Fix unused `path.relative_to()` call in pattern matching logic
  - Move `json` import to module level for consistency
  - Add explanatory comment for `ConnectionResetError` handling
- Fix browser cache preventing live reload from showing updated content
  - Add `bypassCache` option to `fetchNavigation` and `fetchPage` API client functions
  - Use `cache: "no-store"` fetch option when bypassCache is true
  - Navigation store passes bypassCache to API on live reload
  - Page store passes bypassCache to API on live reload
- Implement separate diagram caching for efficient live reload
  - Add content-based diagram caching using SHA-256 hash of source + endpoint + format
  - Add `docstage.core.diagrams` module for diagram rendering with caching
  - Add `FileCache.get_diagram()` and `FileCache.set_diagram()` methods
  - Add `compute_diagram_hash()` utility function
  - Add `MarkdownConverter.extract_html_with_diagrams()` to extract diagrams without rendering
  - Diagrams are only re-rendered when their source code changes
  - Text-only edits to markdown files no longer trigger Kroki requests
- Implement live reload for development mode (RD-001 Phase 5)
  - Add WebSocket endpoint `/ws/live-reload` for real-time file change notifications
  - Add `docstage.live` module with `LiveReloadManager` class
  - Integrate `watchfiles` library for efficient file system monitoring
  - Add `[live_reload]` configuration section with `enabled` and `watch_patterns` options
  - Add `--live-reload/--no-live-reload` CLI flag to `serve` command (enabled by default)
  - Invalidate navigation cache when source files change (page cache uses mtime-based invalidation)
  - Frontend automatically reconnects on connection loss with 2-second retry
  - Navigation tree reloads when any markdown file changes
  - Current page reloads when its source file changes
- Use Roboto font for diagrams with bundled web fonts via `@fontsource/roboto`
  - Strip Google Fonts `@import` from PlantUML SVG output (PlantUML adds it automatically for Roboto)
- Refactor `convert_html_with_diagrams` for better testability
  - Extract `replace_svg_diagrams` and `replace_png_diagrams` helper functions
  - Add `replace_placeholder_with_svg`, `replace_placeholder_with_png`, and `replace_placeholder_with_error` helpers
- Improve diagram rendering robustness and error handling
  - Add per-diagram error handling: failed diagrams show errors while successful ones render
  - Add warning when `format=img` is used (not yet implemented, falls back to inline SVG)
  - Add warnings for unknown attributes (e.g., `formt=png` typo) and invalid format values
  - Replace `unreachable!()` with defensive handling in diagram filter
  - Normalize URL trimming consistently in all Kroki render functions
  - Add `render_all_svg_partial` and `render_all_png_data_uri_partial` for partial success handling
- Add typed `verbose_key` app key for type-safe access
- Simplify `include_dirs` default logic in `PageRenderer`
- Add verbose mode for diagram rendering warnings
  - Add `--verbose` / `-v` flag to `serve` command
  - Log warnings for unresolved `!include` files to stderr
  - Warnings show searched paths for easier debugging
  - `HtmlConvertResult.warnings` property exposes warnings in Python API
- Implement unified configuration file (RD-005)
  - Replace `config.toml` with `docstage.toml` for all settings
  - Add auto-discovery: search for `docstage.toml` in current and parent directories
  - Consolidate server, docs, diagrams, and confluence settings in single file
  - CLI options override config file values when specified
  - Add `--config` option to all commands for explicit config file path
  - Add diagram configuration: `include_dirs`, `config_file`, `dpi`
  - Create `docstage.toml.example` with documented options
- Implement diagram rendering for HTML output (RD-004)
  - Add `DiagramFilter` iterator adapter supporting PlantUML, Mermaid, GraphViz, and 14 other Kroki-supported formats
  - Add `render_all_svg` and `render_all_png_data_uri` functions for SVG and PNG output
  - Add `convert_html_with_diagrams` method to `MarkdownConverter` for HTML with rendered diagrams
  - Diagrams are wrapped in `<figure class="diagram">` for styling
  - Support format attribute in code fence: `plantuml format=png` for PNG instead of default SVG
  - Add `--kroki-url` CLI option to `serve` command to enable diagram rendering
  - Add `kroki_url` parameter to `PageRenderer` for conditional diagram rendering
  - Add frontend CSS for diagram styling (centered, responsive)
  - PlantUML filter retained for backwards compatibility (used by Confluence output)
  - Graceful error handling: failed diagrams show error message instead of causing 500
- Skip non-navigable directories in left navigation
  - Directories without index.md are now excluded from navigation tree
  - Children of such directories are promoted to parent level
  - Prevents 404 errors when clicking navigation items
- Use "/" separator in breadcrumbs via CSS ::after pseudo-element (Stripe-style)
- Skip non-navigable paths in breadcrumbs
  - Breadcrumbs now only include paths with index.md files
  - Prevents 404 errors when clicking breadcrumb links for directories without index.md
- Remove current page from breadcrumbs
  - Breadcrumbs now show only the path to the current page, not including it
  - Backend `_build_breadcrumbs` excludes last path segment
  - Frontend simplified to render all breadcrumb items as links
- Improve ToC sidebar styling
  - Remove left border
  - Position ToC at page H1 level instead of top
  - Article takes full width when ToC is empty, centered when ToC present
- Fix HTML renderer to preserve H1 title and heading levels
  - Title extraction now extracts first H1 without removing it from output
  - Header levels are no longer shifted (H2 stays H2, not H1)
  - ToC excludes page title (first H1) but includes all other headings
  - This differs from Confluence renderer which removes H1 and shifts headers
- Address PR review feedback for bundled assets
  - Fix error message to reference correct build command (`npm run build:bundle`)
  - Add `requires_bundled_assets` skip marker for tests depending on bundled assets
- Fix outdated docstring on `with_title_extraction()` method
- Add test for empty breadcrumbs when parent directory has no index.md

### 2025-12-07
- Bundle frontend assets into Python package (RD-003)
  - Add `docstage.assets` module with `get_static_dir()` for bundled asset discovery
  - Remove `--static-dir` CLI option from `serve` command
  - Server always uses bundled assets from `docstage/static/`
  - Add `npm run build:bundle` script to build and copy frontend to backend
  - Configure hatchling `force-include` to bundle assets in wheel
- Create RD-003: Bundled Frontend Assets requirements document
- Create RD-002: Docstage Frontend requirements document
- Implement Frontend Phase 1: Project Setup
  - Initialize Vite + Svelte 5 project with TypeScript
  - Implement native SPA router using History API (no external library)
  - Configure Tailwind CSS with Typography plugin
  - Create base layout structure (navigation sidebar, content area, ToC sidebar)
  - Set up API client with TypeScript interfaces
  - Add page and navigation Svelte stores
  - Design inspired by Stripe documentation
- Complete Frontend Phase 2: Navigation
  - Add mobile responsive drawer with hamburger menu
  - Auto-close drawer on route change and Escape key
- Complete Frontend Phase 4: Table of Contents
  - Add scroll spy with IntersectionObserver to highlight active heading
- Complete Backend Phase 5: Static File Serving
  - Implement SPA fallback route serving index.html for client-side routing
  - Serve static assets from `/assets` directory
  - Add favicon route at `/favicon.png`
  - API routes take precedence over SPA fallback

### 2025-12-06
- Implement Phase 4: Python Backend - HTTP API
  - Add `docstage.server` module with aiohttp application factory
  - Add `docstage.api.pages` module with `/api/pages/{path}` endpoint
  - Add `docstage.api.navigation` module with `/api/navigation` and `/api/navigation/{path}` endpoints
  - Add `serve` CLI command to start documentation server
  - Add aiohttp and pytest-aiohttp dependencies
  - Implement cache headers (ETag, Last-Modified, Cache-Control) for page responses
  - Add 17 tests for HTTP API endpoints
- Implement Phase 3: Python Backend - Core Library
  - Add `docstage.core.cache` module with file-based caching and mtime invalidation
  - Add `docstage.core.renderer` module wrapping Rust converter with caching
  - Add `docstage.core.navigation` module for building navigation trees from directories
  - Export `HtmlConvertResult` and `TocEntry` from `docstage_core` Python bindings
  - Add 26 tests for core modules (cache, renderer, navigation)
- Pre-Phase 3 code review and improvements
  - Add Python tests for config and CLI (16 tests)
  - Extract `HtmlRenderer` state into dedicated structs (`CodeBlockState`, `TableState`, `ImageState`, `HeadingState`)
  - Collect all Kroki diagram errors via `RenderError::Multiple` instead of failing on first
  - Make DPI configurable via `MarkdownConverter::dpi()` builder method
  - Add comprehensive module-level rustdoc comments
  - Add pytest as dev dependency group
- Implement Phase 2: Rust Core - HTML Renderer
  - Add `HtmlRenderer` module producing semantic HTML5
  - Generate heading IDs for anchor links
  - Create `TocEntry` struct for table of contents
  - Add `MarkdownConverter::convert_html()` method
  - Update Python bindings with `HtmlConvertResult` and `TocEntry` classes
  - Preserve inline formatting in headings (code, emphasis, strong, links)
  - Add table column alignment support via inline styles
  - Code blocks output `language-*` class for client-side highlighting
- Create RD-001: Docstage Backend requirements document
- Define API design for page rendering and navigation endpoints
- Plan implementation phases for HTML renderer, core library, HTTP API, and live reload

### 2025-12-05
- Rename project from md2conf to Docstage ("Where documentation takes the stage")
- Rename packages: md2conf → docstage, md2conf-core → docstage-core
- Update CLI entrypoint: `md2conf` → `docstage`
- Restructure Rust code into Cargo workspace:
  - `crates/docstage-core`: Pure Rust library (no PyO3)
  - `packages/docstage-core`: Python package with PyO3 bindings (maturin)
- Move conversion logic from PyO3 bindings to `docstage-core::MarkdownConverter`

### 2025-12-04
- Merge `convert_with_diagrams` into `convert` method (kroki_url/output_dir now required)
- Move Kroki diagram rendering from Python to Rust with parallel requests (rayon + ureq)

### 2025-12-01
- Comment preservation for inline comments on page updates
- OAuth signature fix: `force_include_body=True` for POST/PUT
- Markdown to Confluence converter via Rust core
- Confluence REST API client with OAuth 1.0 RSA-SHA1
- CLI: `convert`, `create`, `update`, `get-page`, `generate-tokens`, `test-auth`
